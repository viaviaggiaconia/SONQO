<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>SONQO</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&display=swap" rel="stylesheet"/>


  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a0e1e">
  <link rel="apple-touch-icon" href="./icons/sonqo-180.png">
  <link rel="icon" sizes="192x192" href="./icons/sonqo-192.png">
  <link rel="icon" sizes="512x512" href="./icons/sonqo-512.png">

  <link rel="stylesheet" href="./styles.css">
  <script type="module" defer src="./app.js"></script>
</head>
<body>
  <video id="bgVideo" class="bg-video" autoplay muted loop playsinline preload=\"metadata\"></video>
<canvas id="bgCanvas" aria-hidden="true"></canvas>

<!-- Mic (muto/attivo) -->
<button id="micBtn" class="control-toggle" aria-label="Microfono" aria-pressed="false" title="Muto">
  <!-- mic on -->
  <svg class="icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3z"/>
    <path d="M19 10v1a7 7 0 0 1-14 0v-1"/>
    <path d="M12 19v3"/>
  </svg>
  <!-- mic off -->
  <svg class="icon-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
    <path d="M9 9v3a3 3 0 0 0 4.5 2.6M15 9v3a3 3 0 0 1-.2 1"/>
    <path d="M19 10v1a7 7 0 0 1-10.59 6"/>
    <path d="M12 19v3"/>
    <path d="M2 2l20 20"/>
  </svg>
</button>


<!-- Info (disclaimer) -->
<button id="infoBtn" class="control-toggle info" aria-label="Informazioni" title="Informazioni">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"></circle>
    <line x1="12" y1="8" x2="12" y2="8"></line>
    <line x1="12" y1="12" x2="12" y2="16"></line>
  </svg>
</button>

<!-- Info Panel -->
<div id="infoPanel" class="panel" role="dialog" aria-label="Informazioni">
  <h4>Informazioni & Privacy</h4>
  <div class="small-note">
    I pensieri che inserisci restano <b>privati</b> e memorizzati solo sul tuo dispositivo. 
  </div>
  <div class="small-note">
    <b>Disclaimer:</b> SONQO è uno strumento di intrattenimento e benessere personale. Non sostituisce in alcun modo il parere di medici o professionisti della salute.
    Se stai attraversando un momento difficile, considera di rivolgerti a uno specialista.
  </div>
</div>

<!-- Gear (impostazioni) -->
<button id="gearBtn" class="control-toggle gear" aria-label="Impostazioni" title="Impostazioni">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="3"></circle>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.39 1.26 1 1.51H21a2 2 0 1 1 0 4h-.09c-.61.25-1 .85-1 1.49Z"></path>
  </svg>
</button>

<!-- Pannello -->
<div id="ctrlPanel" class="panel" role="dialog" aria-label="Controlli">
  <h4>Audio</h4>
  <div class="row"><label for="volumeRange">Volume</label><input id="volumeRange" type="range" min="0" max="100" value="34"/></div>
  <div class="row"><label for="intensityRange">Intensità</label><input id="intensityRange" type="range" min="0" max="100" value="62"/></div>
  <div class="row"><label for="reverbRange">Riverbero</label><input id="reverbRange" type="range" min="0" max="100" value="38"/></div>
  <div class="small-note">Ogni tema ha il suo paesaggio sonoro (onde, pioggia, grilli, vento…).</div>

  <h4>Video</h4>
  <div class="row"><label for="detailSel">Dettagli grafici</label>
    <select id="detailSel"><option value="rich" selected>Ricchi</option><option value="normal">Normali</option><option value="lite">Leggeri</option></select>
  </div>
  <div class="row"><label for="transitionRange">Velocità transizioni</label><input id="transitionRange" type="range" min="10" max="80" value="35"/></div>
  <div class="small-note">La qualità parte <b>massima</b> e si adatta automaticamente se il dispositivo rallenta.</div>
</div>

<div class="container" role="application" aria-label="SONQO Mindfulness">
  <!-- Splash -->
  <section id="splash" class="screen splash active">
    <div class="inner"><div class="center">
      <div class="logo">SONQO</div>
      <div class="tag">Il tuo angolo di pace.<br/>Una dose di saggezza, quando serve.</div>
<div class="whiteText small" style="opacity:.95;margin-top:8px">I pensieri salvati restano privati e solo sul tuo dispositivo.</div>
      <button class="btn ghost" id="startBtn" aria-label="Inizia">Inizia</button>
    </div></div>
  </section>

  <!-- Selettore tema -->
  <section id="theme" class="screen" aria-labelledby="themeTitle">
    <div class="inner" style="padding:0">
      <h2 id="themeTitle" class="visually-hidden">Selezione tema</h2>
      <div class="swipe" id="swipe">
        <div class="slides" id="slides" aria-live="polite"></div>
        <div class="pager" id="pager" aria-label="Pagine"></div>
        <div class="hint">Trascina • Rotella • Frecce ← → • Clicca i punti</div>
      </div>
      <div class="bottom pad" style="display:flex;justify-content:center">
        <button class="btn ghost" id="confirmTheme">Conferma tema →</button>
      </div>
    </div>
  </section>

  <!-- Auth -->
  <section id="authLanding" class="screen auth">
    <div class="inner"><div class="center">
      <h1 class="whiteText">ACCEDI</h1><p class="whiteText small">Prenditi un momento per te oggi.</p>
      <button class="btn ghost" id="goLogin">Vai all'accesso</button>
      <div style="height:16px"></div>
      <h1 class="whiteText">REGISTRATI</h1><p class="whiteText small">È gratis, come il tempo che dedichi a te stesso.</p>
      <button class="btn ghost" id="goRegister">Crea account</button>
    </div></div>
  </section>

  <!-- Login -->
  <section id="login" class="screen">
    <div class="inner">
      <div class="top"></div><div class="center"><h2 class="whiteText login-title">Bentornato</h2><div id="loginMsg" class="message"></div>
        <input id="loginEmail" type="email" placeholder="La tua email"/>
        <input id="loginPass" type="password" placeholder="Password"/>
        <button class="btn ghost" id="loginBtn">Accedi</button>
        <button class="btn ghost" id="toRegister">Crea un account</button>
      </div>
    </div>
  </section>

  <!-- Register -->
  <section id="register" class="screen">
    <div class="inner">
      <div class="top"><h2 class="whiteText">Crea il tuo spazio</h2><div id="regMsg" class="message"></div></div>
      <div class="center">
        <input id="regName" placeholder="Il tuo nome"/>
        <input id="regEmail" type="email" placeholder="Email"/>
        <input id="regPass" type="password" placeholder="Crea password"/>
        <button class="btn ghost" id="registerBtn">Registrati</button>
        <button class="btn ghost" id="toLogin">Hai già un account?</button>
      </div>
    </div>
  </section>

  <!-- Jar -->
  <section id="jar" class="screen">
    <div class="inner">
      <div class="top headerBar">
        <div class="brand">SONQO</div>
        <div class="userMeta"><b id="hiName">Ciao</b> • <span id="count">0</span> pensieri</div>
        <div class="instruction">Tocca o clicca il contenitore per estrarre una frase</div>
      </div>
      <div class="center">
        <div class="jarWrap">
          <div class="jar" id="jarTap" title="Estrai frase" aria-label="Vaso dei pensieri"></div>
          <div class="phraseBubble" id="bubble" aria-live="polite">Tocca il vaso per estrarre un pensiero</div>
          <div class="whiteText small">…oppure aggiungi un nuovo pensiero</div>
          <div class="inlineAdd">
            <input id="inlineInput" placeholder="Scrivi un pensiero positivo..."/>
            <button class="btn ghost" id="saveInline" style="width:auto;white-space:nowrap;padding:0 8px">Salva</button></div>
      </div>
      <div class="bottom" style="display:flex;justify-content:center;gap:10px">
        <button class="btn ghost" id="logoutBtn" style="max-width:180px">Esci</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ===== Helpers & State ===== */
const DPR = Math.min(window.devicePixelRatio||1,2);
const TAU = Math.PI*2;
const S = id => document.getElementById(id);
let isThemeScreen=false, lastPreviewKey=null;

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  S(id).classList.add('active');
  isThemeScreen = (id==='theme');
  document.body.classList.toggle('themeScreen', isThemeScreen);
}
function rng(seed){ return function(){ seed=(seed*1664525+1013904223)>>>0; return (seed&0xffffffff)/0x100000000; }; }
/* ellipse polyfill */
if(!CanvasRenderingContext2D.prototype.ellipse){
  CanvasRenderingContext2D.prototype.ellipse=function(x,y,rx,ry,rot,sa,ea,ccw){
    this.save(); this.translate(x,y); this.rotate(rot||0); this.scale(rx,ry);
    this.arc(0,0,1,sa||0,ea||TAU,!!ccw); this.restore();
  }
}
function pathRoundedRect(ctx,x,y,w,h,r){
  r=Math.max(0,Math.min(r,Math.min(w,h)/2));
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y); ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w,y+h-r); ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
  ctx.lineTo(x+r,y+h); ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x,y+r); ctx.arcTo(x,y,x+r,y,r);
  ctx.closePath();
}
const RAD = v => Math.max(0.5, Math.abs(v) || 0.5);

/* ===== Device-aware abundance ===== */
const PERF={mem:(navigator.deviceMemory||4), cores:(navigator.hardwareConcurrency||4)};
let DENSITY = PERF.mem>=8 ? 1.2 : PERF.mem>=4 ? 1.0 : 0.85;

/* ===== Palettes & Themes ===== */
const PALETTES = {
  showcase:['#dfe7f1','#cfd9e6','#b7c7d6','#92b0c7','#eaf6ff'],
  night:['#0a0e1e','#131c38','#1b2a58','#2e3e86','#a4bbff'],
  mountains:['#dff1fa','#b7d3e8','#8fb6d1','#6ea0bf','#4d85a9'],
  desert:['#fff2db','#f6e4c6','#efcaa0','#e2b27f','#c9925f'],
  sunset:['#ffe9dc','#ffc7a1','#ff9a67','#ff7848','#f2552b'],
  forest:['#e4f8ee','#c4efd9','#9fe1bf','#7dc190','#5ea874'],
  ocean:['#e6fbff','#c6f2ff','#9bdcf1','#7ec7eb','#5ba5cf'],
  rain:['#dbe6f2','#bdcfe1','#8fa6c1','#6d86a6','#4c5e7f'],
  fog:['#eef2f5','#dde5ea','#c7d3db','#b4c1cc','#9cabb8'],
  aurora:['#0a0f2a','#0e1c45','#153d67','#2ab07c','#a66df2']
};
const THEMES = [
  {key:'night',label:'Notte Stellata'},
  {key:'mountains',label:'Montagne'},
  {key:'ocean',label:'Oceano'},
  {key:'sunset',label:'Tramonto sul mare'},
  {key:'desert',label:'Deserto'},
  {key:'forest',label:'Foresta'},
  {key:'rain',label:'Pioggia'},
  {key:'fog',label:'Nebbia'},
  {key:'aurora',label:'Aurora'}
];

// Optional video sources for each theme (use your own files/URLs)
const THEME_VIDEOS = {
  night:    { mp4: 'media/night.mp4',    webm: 'media/night.webm',    poster: 'media/night.jpg' },
  mountains:{ mp4: 'media/mountains.mp4',webm: 'media/mountains.webm',poster: 'media/mountains.jpg' },
  ocean:    { mp4: 'media/ocean.mp4',    webm: 'media/ocean.webm',    poster: 'media/ocean.jpg' },
  sunset:   { mp4: 'media/sunset.mp4',   webm: 'media/sunset.webm',   poster: 'media/sunset.jpg' },
  desert:   { mp4: 'media/desert.mp4',   webm: 'media/desert.webm',   poster: 'media/desert.jpg' },
  forest:   { mp4: 'media/forest.mp4',   webm: 'media/forest.webm',   poster: 'media/forest.jpg' },
  rain:     { mp4: 'media/rain.mp4',     webm: 'media/rain.webm',     poster: 'media/rain.jpg' },
  fog:      { mp4: 'media/fog.mp4',      webm: 'media/fog.webm',      poster: 'media/fog.jpg' },
  aurora:   { mp4: 'media/aurora.mp4',   webm: 'media/aurora.webm',   poster: 'media/aurora.jpg' },
  showcase: { mp4: 'media/showcase.mp4', webm: 'media/showcase.webm', poster: 'media/showcase.jpg' }
};


/* ===== UI per tema ===== */
const THEME_UI = {
  showcase:{accent:'#5aa9d6',accent2:'#79c2ea', glass:'rgba(255,255,255,.10)', brd:'rgba(255,255,255,.22)', mobile:'rgba(255,255,255,.04)', panel:'rgba(18,32,51,.55)', pbrd:'rgba(255,255,255,.28)'},
  night:{accent:'#a4bbff',accent2:'#6b8cff', glass:'rgba(10,14,30,.28)', brd:'rgba(164,187,255,.28)', mobile:'rgba(10,14,30,.16)', panel:'rgba(10,14,30,.45)', pbrd:'rgba(164,187,255,.35)'},
  mountains:{accent:'#4d85a9',accent2:'#79b8d6', glass:'rgba(255,255,255,.12)', brd:'rgba(255,255,255,.24)', mobile:'rgba(255,255,255,.05)', panel:'rgba(42,62,84,.40)', pbrd:'rgba(190,220,255,.32)'},
  ocean:{accent:'#3a87b9',accent2:'#63b6e1', glass:'rgba(12,28,48,.20)', brd:'rgba(120,180,220,.30)', mobile:'rgba(12,28,48,.12)', panel:'rgba(12,28,48,.46)', pbrd:'rgba(120,180,220,.36)'},
  sunset:{accent:'#ff7848',accent2:'#f2552b', glass:'rgba(60,24,8,.18)', brd:'rgba(255,180,120,.28)', mobile:'rgba(60,24,8,.10)', panel:'rgba(60,24,8,.44)', pbrd:'rgba(255,200,150,.34)'},
  desert:{accent:'#c9925f',accent2:'#e2b27f', glass:'rgba(64,40,10,.16)', brd:'rgba(255,225,200,.26)', mobile:'rgba(64,40,10,.10)', panel:'rgba(64,40,10,.42)', pbrd:'rgba(255,225,200,.34)'},
  forest:{accent:'#5ea874',accent2:'#7dc190', glass:'rgba(10,32,18,.20)', brd:'rgba(170,220,190,.28)', mobile:'rgba(10,32,18,.12)', panel:'rgba(10,32,18,.44)', pbrd:'rgba(170,220,190,.34)'},
  rain:{accent:'#6d86a6',accent2:'#4c5e7f', glass:'rgba(12,20,36,.22)', brd:'rgba(200,220,250,.22)', mobile:'rgba(12,20,36,.12)', panel:'rgba(12,20,36,.46)', pbrd:'rgba(200,220,250,.30)'},
  fog:{accent:'#9cabb8',accent2:'#b4c1cc', glass:'rgba(32,42,56,.16)', brd:'rgba(255,255,255,.20)', mobile:'rgba(32,42,56,.10)', panel:'rgba(32,42,56,.42)', pbrd:'rgba(255,255,255,.28)'},
  aurora:{accent:'#6ea8ff',accent2:'#a66df2', glass:'rgba(12,18,40,.26)', brd:'rgba(150,180,255,.30)', mobile:'rgba(12,18,40,.16)', panel:'rgba(12,18,40,.46)', pbrd:'rgba(150,180,255,.36)'}
};
function applyThemeUI(key){
  const ui = THEME_UI[key] || THEME_UI.showcase;
  const r = document.documentElement.style;
  r.setProperty('--accent', ui.accent);
  r.setProperty('--accent-2', ui.accent2);
  r.setProperty('--glass-bg', ui.glass);
  r.setProperty('--glass-brd', ui.brd);
  r.setProperty('--glass-bg-mobile', ui.mobile);
  r.setProperty('--panel-bg', ui.panel);
  r.setProperty('--panel-brd', ui.pbrd);
}

/* ===== Pannello + Toggles ===== */
const ctrlPanel=S('ctrlPanel');
function togglePanel(){ ctrlPanel.classList.toggle('show'); }

/* ===== Video controls ===== */
const detailSel=S('detailSel'), transitionRange=S('transitionRange');

/* ===== Canvas & Quality ===== */
const canvas=document.getElementById('bgCanvas');
const ctx=canvas.getContext('2d',{alpha:true});
let W=0,H=0,t=0,last=0, currentTheme='night', prevTheme='night', transition=0;
let transitionSpeed=.02;

/* pools / geom — UNICA DICHIARAZIONE */
let stars=null, shooting=null, rainDrops=null, fogLayers=null;
let forestLayers=null, fireflies=null, birds=null, snowFlakes=null, clouds=null;
let mountainRidges=null, duneLayers=null, desertProps=null, snowCaps=null, gulls=null, boat=null;
/* desert gust state */
let desertGust={active:false, until:0, next:4000}, sandBurst=null;

/* FX */
let fxSeed=0, noiseTex=null, noisePattern=null;
function makeNoiseTexture(size=192){
  const c=document.createElement('canvas'); c.width=c.height=size;
  const x=c.getContext('2d'); const img=x.createImageData(size,size);
  for(let i=0;i<img.data.length;i+=4){ const n=220+(Math.random()*35|0); img.data[i]=img.data[i+1]=img.data[i+2]=n; img.data[i+3]=34; }
  x.putImageData(img,0,0); return c;
}
function ensureFX(){ if(!noiseTex){ noiseTex=makeNoiseTexture(); noisePattern=ctx.createPattern(noiseTex,'repeat'); } }
function applyFX(){
  ensureFX();
  ctx.save(); ctx.globalAlpha=.10*QUALITY.fx; ctx.translate((fxSeed%noiseTex.width),(fxSeed%noiseTex.height));
  ctx.fillStyle=noisePattern; ctx.fillRect(-noiseTex.width,-noiseTex.height,W+noiseTex.width*2,H+noiseTex.height*2); ctx.restore();
  const vg=ctx.createRadialGradient(W*.5,H*.52,0,W*.5,H*.52,Math.max(W,H)*.7);
  vg.addColorStop(0,'rgba(0,0,0,0)'); vg.addColorStop(1,'rgba(0,0,0,.26)'); ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
  const pal=PALETTES[currentTheme]||PALETTES.showcase; ctx.fillStyle=pal[4]+'22'; ctx.fillRect(0,0,W,H); fxSeed+=0.6*DPR;
}

/* Qualità + Dettaglio */
const QUALITY={scale:1.55,fx:1,detail:'rich'}; /* parte al massimo */
let DETAIL_MULT=1.15;

/* FPS-based autoscale */
let fps=60,fpsAccum=0,fpsFrames=0;
const MAX_SCALE=1.55, MIN_SCALE=0.65;
let targetScale=MAX_SCALE;

function autoQualityTick(dt){
  fpsAccum+=dt; fpsFrames++; 
  if(fpsAccum>=1000){
    fps=Math.min(120,Math.round(1000*fpsFrames/fpsAccum)); fpsAccum=0; fpsFrames=0;
    if(fps<30) targetScale=Math.max(MIN_SCALE, targetScale-0.18);
    else if(fps<45) targetScale=Math.max(MIN_SCALE, targetScale-0.10);
    else if(fps>58) targetScale=Math.min(MAX_SCALE, targetScale+0.05);
    QUALITY.scale += (targetScale - QUALITY.scale)*0.25;
    QUALITY.fx = 0.8 + 0.2*(QUALITY.scale/MAX_SCALE);
    /* reset SOLO elementi dinamici, NON le geometrie statiche del deserto (cactus/rocce/dune) o barche/gabbiani */
    stars=rainDrops=fogLayers=forestLayers=fireflies=birds=snowFlakes=clouds=null;
  }
}
function refreshDetail(){
  QUALITY.detail=detailSel.value;
  DETAIL_MULT = QUALITY.detail==='rich'?1.15:(QUALITY.detail==='lite'?0.9:1.0);
  /* idem: non tocco cactus/rocce/dune */
  stars=rainDrops=fogLayers=forestLayers=fireflies=birds=snowFlakes=clouds=null;
}
detailSel.addEventListener('change',refreshDetail);
transitionRange.addEventListener('input',()=>{ transitionSpeed = Math.max(.008, Number(transitionRange.value)/2000); });

/* Resize */
function onResize(){
  W=canvas.width=Math.floor(innerWidth*DPR);
  H=canvas.height=Math.floor(innerHeight*DPR);
  canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px';
  /* su resize ricostruisco tutto, ok */
  stars=rainDrops=fogLayers=forestLayers=fireflies=birds=snowFlakes=clouds=mountainRidges=duneLayers=desertProps=snowCaps=gulls=boat=null;
}
addEventListener('resize',()=>{ onResize(); forceSnap(); });
addEventListener('orientationchange',()=>{ setTimeout(()=>{ onResize(); forceSnap(); }, 200); });
onResize();

/* ===== NIGHT / SHOWCASE ===== */
const CONSTELLATIONS = [
  { name:'Orsa Maggiore', pts:[[0.10,0.18],[0.16,0.22],[0.22,0.20],[0.29,0.23],[0.36,0.28],[0.44,0.32],[0.52,0.30]], edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,6]] },
  { name:'Cassiopea', pts:[[0.70,0.18],[0.74,0.22],[0.78,0.19],[0.82,0.23],[0.86,0.20]], edges:[[0,1],[1,2],[2,3],[3,4]] }
];
function drawShowcase(){
  const p=PALETTES.showcase; ctx.clearRect(0,0,W,H);
  let sky=ctx.createLinearGradient(0,0,0,H); sky.addColorStop(0,p[0]); sky.addColorStop(1,p[1]); ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha=.16;
  for(let i=0;i<6;i++){
    const y=H*(.25 + i*.1), a=18*DPR*(1+i*.2);
    ctx.beginPath(); ctx.moveTo(0,y);
    for(let x=0;x<=W;x+=22*DPR){ ctx.lineTo(x, y + Math.sin(x*0.002 + t*0.00025+i)*a ); }
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fillStyle=p[2+(i%2)]+'66'; ctx.fill();
  }
  ctx.globalAlpha=1;
  if(Math.min(QUALITY.scale,1)>0.8){ ctx.fillStyle='#fff';
    const n=Math.floor(90*QUALITY.scale*DENSITY*DETAIL_MULT);
    for(let i=0;i<n;i++){ const x=(i*59 + t*0.03)%W, y=(i*83 + t*0.02)%H; ctx.globalAlpha=.10+.4*((i%7)/7); ctx.beginPath(); ctx.arc(x,y,2.1*DPR,0,TAU); ctx.fill(); }
    ctx.globalAlpha=1;
  }
}
function ensureStars(){ if(stars) return; const base=(QUALITY.detail==='rich'?300:QUALITY.detail==='lite'?180:240)*DENSITY*DETAIL_MULT; stars=Array.from({length:Math.floor(base*QUALITY.scale)},()=>({x:Math.random()*W,y:Math.random()*H*.9,r:(Math.random()*1.8+0.6)*DPR,speed:(0.03+Math.random()*0.07)*DPR,tw:Math.random()*TAU})); }
function maybeShooting(){ if(!shooting && Math.random()<0.001){ shooting={x:W*(.6+.4*Math.random()),y:H*(.08+.18*Math.random()),vx:-1.1*DPR,vy:0.38*DPR,life:2200}; } }
function drawConstellations(){
  ctx.save(); ctx.lineWidth=1*DPR; ctx.globalAlpha=.35; ctx.strokeStyle='#cfe0ff';
  CONSTELLATIONS.forEach(c=>{
    const pts=c.pts.map(([nx,ny])=>[nx*W, ny*H*.6+H*.05]);
    c.edges.forEach(([a,b])=>{ ctx.beginPath(); ctx.moveTo(pts[a][0],pts[a][1]); ctx.lineTo(pts[b][0],pts[b][1]); ctx.stroke(); });
    pts.forEach(([x,y])=>{ ctx.globalAlpha=.8; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,1.8*DPR,0,TAU); ctx.fill(); ctx.globalAlpha=.35; });
  });
  ctx.restore();
}
function drawNight(dt){
  const c=PALETTES.night; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,c[0]); g.addColorStop(1,c[2]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ensureStars();
  for(const s of stars){ const near=s.r>1.6; s.x-=s.speed*(near?1.3:1); if(s.x<-10){s.x=W+10;s.y=Math.random()*H*.9;} s.tw+=dt*(near?0.002:0.0013); const a=.55+.45*Math.sin(s.tw); ctx.globalAlpha=a; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*(near?1.15:1),0,TAU); ctx.fillStyle='#fff'; ctx.fill(); }
  ctx.globalAlpha=1; drawConstellations();
  const mx=W*.86,my=H*.18,mr=56*DPR; let glow=ctx.createRadialGradient(mx,my,0,mx,my,mr*1.6); glow.addColorStop(0,'#ffffffaa'); glow.addColorStop(1,'#0000'); ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(mx,my,mr*1.6,0,TAU); ctx.fill();
  ctx.fillStyle='#fff'; ctx.globalAlpha=.38; ctx.beginPath(); ctx.arc(mx,my,mr,0,TAU); ctx.fill(); ctx.globalAlpha=1;
  ctx.fillStyle=c[1]; ctx.globalAlpha=.28; ctx.beginPath(); ctx.moveTo(0,H);
  for(let x=0;x<=W;x+=28*DPR){ const y=H*.78 + Math.sin((x*0.003+t*0.0003))*14*DPR + Math.sin((x*0.0015+t*0.0002))*7*DPR; ctx.lineTo(x,y); }
  ctx.lineTo(W,H); ctx.closePath(); ctx.fill(); ctx.globalAlpha=1;
  maybeShooting(); if(shooting){ ctx.strokeStyle='#fff'; ctx.globalAlpha=.85; ctx.lineWidth=1.0*DPR; ctx.beginPath(); ctx.moveTo(shooting.x,shooting.y); ctx.lineTo(shooting.x+28*DPR,shooting.y-10*DPR); ctx.stroke(); shooting.x+=shooting.vx; shooting.y+=shooting.vy; shooting.life-=dt; if(shooting.x<-40 || shooting.life<=0) shooting=null; ctx.globalAlpha=1; }
}

/* ===== MOUNTAINS ===== */
function buildRidgePoints(yBase, amplitude, seg, rough, seed){ const rand=rng(seed); const pts=[]; const step=W/seg; for(let i=0;i<=seg;i++){ const x=i*step; const dy=(rand()*2-1)*amplitude*rough + (i%2? amplitude*0.35 : -amplitude*0.2); pts.push([x, yBase + dy]); } return pts; }
function ensureRidges(){ if(mountainRidges) return; mountainRidges=[]; snowCaps=[];
  for(let i=0;i<4;i++){
    const y=H*(.55 + i*.08), amp=(22+i*10)*DPR, seg=18, rough=.55 - i*.1, seed=(W|0)+(H|0)+i*12345;
    const pts=buildRidgePoints(y,amp,seg,rough,seed);
    mountainRidges.push({pts, col:PALETTES.mountains[2+(i%3)], alpha:.18+.08*i});
    if(i<2){ for(let k=1;k<pts.length-1;k++){ const [x,yc]=pts[k]; if(yc<y-amp*.25){ snowCaps.push({x, y:yc, w:22*DPR, h:10*DPR, a:.65 - i*.2}); } } }
  }
}
function drawRidge(r){ ctx.fillStyle=r.col; ctx.globalAlpha=r.alpha; ctx.beginPath(); ctx.moveTo(0,H); r.pts.forEach(([x,y])=> ctx.lineTo(x,y)); ctx.lineTo(W,H); ctx.closePath(); ctx.fill(); ctx.globalAlpha=1; }
function ensureClouds(){ if(clouds) return; const n=(QUALITY.detail==='rich'?5:QUALITY.detail==='lite'?2:4)*DETAIL_MULT; clouds = Array.from({length:Math.floor(n*DENSITY)},()=>({x:Math.random()*W, y:H*(.15+.25*Math.random()), w:(160+Math.random()*220)*DPR, h:(40+Math.random()*60)*DPR, v:(.02+.04*Math.random())*DPR})); }
function drawClouds(col){ if(!clouds) return; ctx.fillStyle=col; clouds.forEach(cl=>{ ctx.globalAlpha=.16; ctx.beginPath(); ctx.ellipse(cl.x,cl.y,cl.w,cl.h,0,0,TAU); ctx.fill(); cl.x+=cl.v; if(cl.x>W+cl.w) cl.x=-cl.w; }); ctx.globalAlpha=1; }
function ensureBirds(){ if(birds) return; birds = Array.from({length:2},()=>({x:Math.random()*W, y:H*(.25+.2*Math.random()), a:Math.random()*TAU, dir:Math.random()<.5?-1:1, sp:(.02+.03*Math.random())*DPR})); }
function drawBirds(){ if(!birds) return; ctx.fillStyle='#1a2b44'; ctx.globalAlpha=.55; birds.forEach(b=>{ b.x+=b.sp*b.dir*60; b.y+=Math.sin(t*0.0005+b.a)*.3*DPR; if(b.x<-20) b.x=W+20; if(b.x>W+20) b.x=-20; ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.x-8*DPR*b.dir,b.y+3*DPR); ctx.lineTo(b.x-16*DPR*b.dir,b.y); ctx.closePath(); ctx.fill(); }); ctx.globalAlpha=1; }
function drawSnowCaps(){ if(!snowCaps) return; ctx.fillStyle='#fff'; snowCaps.forEach(s=>{ ctx.globalAlpha=s.a; ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x - s.w*.5, s.y + s.h); ctx.lineTo(s.x + s.w*.5, s.y + s.h*.8); ctx.closePath(); ctx.fill(); }); ctx.globalAlpha=1; }
function drawMountains(dt){
  const c=PALETTES.mountains; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,c[0]); g.addColorStop(1,c[1]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ensureRidges(); mountainRidges.forEach(drawRidge); drawSnowCaps();
  ensureClouds(); drawClouds('#ffffff'); ensureBirds(); drawBirds();
}

/* ===== FOREST ===== */
function buildForestLayer(width,height,seed,colorBase,scale=1){
  const off=document.createElement('canvas'); off.width=width; off.height=height; const x=off.getContext('2d'); const rand=rng(seed);
  const base = (QUALITY.detail==='rich'? 80 : QUALITY.detail==='lite'? 48 : 66)*DENSITY*DETAIL_MULT;
  const nTrees = Math.floor((base + 34*scale) * QUALITY.scale);
  function pine(cx,baseY,h,color){
    x.fillStyle=color+'cc';
    pathRoundedRect(x, cx-1.5*DPR, baseY-h*0.12, 3*DPR, h*0.12, 1.5*DPR); x.fill();
    for(let i=0;i<3;i++){
      const topY = baseY - h*(.35 + i*.22);
      const w = h*(.35 + i*.28);
      x.beginPath(); x.moveTo(cx, topY - h*.12);
      x.lineTo(cx - w*.5, baseY - h*(.15*i));
      x.lineTo(cx + w*.5, baseY - h*(.15*i));
      x.closePath();
      x.globalAlpha=.86 - i*.16; x.fillStyle=color; x.fill();
    } x.globalAlpha=1;
  }
  const fogGrad=x.createLinearGradient(0,0,0,height); fogGrad.addColorStop(0,'#ffffff00'); fogGrad.addColorStop(1,'#ffffff22');
  for(let i=0;i<nTrees;i++){
    const cx = rand()*width; const baseY = height*.62 + rand()*height*.28; const h = (40 + rand()*120) * DPR * (0.8 + scale*0.2);
    const shade = Math.floor(140 + rand()*60); const col = `rgb(${shade-20},${shade+40},${shade-10})`;
    pine(cx, baseY, h, col);
  }
  x.fillStyle=fogGrad; x.fillRect(0,0,width,height); return off;
}
function ensureForest(){ if(forestLayers) return;
  const p=PALETTES.forest; forestLayers=[]; const Wex=Math.floor(W*1.8), Hlay=Math.floor(H*0.95);
  for(let i=0;i<5;i++){
    const seed=(i+1)*12345 + Math.floor(W+H);
    const layerCanvas = buildForestLayer(Wex,Hlay,seed,p[2+(i%3)], 1+i*0.18);
    const y = H*.33 + i*H*.12; const sway = .7 + i*.17; const parallax = .05 + i*.055;
    forestLayers.push({img:layerCanvas, y, sway, parallax, xoff:0});
  }
}
function ensureFireflies(){ if(fireflies) return; const base=(QUALITY.detail==='rich'?100:QUALITY.detail==='lite'?44:70)*DENSITY*DETAIL_MULT; fireflies = Array.from({length:Math.floor(base*QUALITY.scale)},()=>({x:Math.random()*W,y:H*(.45+.45*Math.random()), a:Math.random()*TAU, r:(1+Math.random()*2)*DPR})); }
function drawFireflies(){ if(!fireflies) return; ctx.fillStyle='#fff'; fireflies.forEach(f=>{ const tw = (1+Math.sin(t*0.002+f.a))*0.5; ctx.globalAlpha=.25+.75*tw; ctx.beginPath(); ctx.arc(f.x,f.y,f.r*(.6+tw*.6),0,TAU); ctx.fill(); f.x += Math.sin(t*0.001+f.a)*0.12*DPR; f.y += Math.cos(t*0.0011+f.a)*0.08*DPR; if(f.x<-10) f.x=W+10; if(f.x>W+10) f.x=-10; if(f.y>H) f.y=H*.5; }); ctx.globalAlpha=1; }
function drawForest(dt){
  const c=PALETTES.forest; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,c[0]); g.addColorStop(1,c[1]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ensureForest();
  for(let i=0;i<10;i++){
    const rx=(110+(i%5)*26)*DPR; const x0=W*.5+Math.cos(t*0.00035+i*.7)*W*.35; const y0=H*.50+Math.sin(t*0.00028+i*.9)*H*.22;
    const grd=ctx.createRadialGradient(x0,y0,0,x0,y0,rx); grd.addColorStop(0,c[2]+'66'); grd.addColorStop(1,c[4]+'00');
    ctx.fillStyle=grd; ctx.globalAlpha=.16; ctx.beginPath(); ctx.arc(x0,y0,rx,0,TAU); ctx.fill();
  } ctx.globalAlpha=1;
  for(let i=0;i<forestLayers.length;i++){
    const L=forestLayers[i]; const wind = Math.sin(t*0.0008 + i)*10*DPR*L.sway; L.xoff = (wind) % L.img.width;
    const sx = - (L.img.width - W)/2; const x1 = sx + L.xoff*L.parallax;
    ctx.globalAlpha=.86 - i*.1; ctx.drawImage(L.img, x1, L.y, L.img.width, L.img.height); ctx.drawImage(L.img, x1-L.img.width, L.y, L.img.width, L.img.height);
  }
  ctx.globalAlpha=1; ctx.fillStyle=c[4]+'66'; ctx.beginPath(); ctx.moveTo(0,H);
  for(let x=0;x<=W;x+=22*DPR){ const y=H*.88 + Math.sin(x*0.002 + t*0.0004)*6*DPR; ctx.lineTo(x,y); }
  ctx.lineTo(W,H); ctx.closePath(); ctx.fill(); ensureFireflies(); drawFireflies();
}

/* ===== OCEAN ===== */
function drawOcean(dt){
  const c=PALETTES.ocean; ctx.clearRect(0,0,W,H);
  let sky=ctx.createLinearGradient(0,0,0,H); sky.addColorStop(0,c[0]); sky.addColorStop(1,c[1]); ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
  const bx=W*.82, by=H*.70;
  ctx.fillStyle='#263e5a'; ctx.globalAlpha=.95;
  ctx.beginPath(); ctx.moveTo(bx-120*DPR,by+40*DPR); ctx.quadraticCurveTo(bx-40*DPR,by-30*DPR,bx+20*DPR,by+10*DPR); ctx.lineTo(bx+120*DPR,by+60*DPR); ctx.lineTo(bx-120*DPR,by+60*DPR); ctx.closePath(); ctx.fill();
  const h=150*DPR; ctx.fillStyle='#17324d';
  ctx.fillRect(bx-10*DPR,by-h,20*DPR,h); ctx.fillRect(bx-16*DPR,by-h*0.85,32*DPR,6*DPR); ctx.fillRect(bx-12*DPR,by-h*0.15,24*DPR,6*DPR);
  const ang = (t*0.00025)%TAU, spread=.28; const g=ctx.createRadialGradient(bx,by-h*.92,0,bx,by-h*.92,W*.6);
  g.addColorStop(0,'#ffffccaa'); g.addColorStop(1,'#ffffff00'); ctx.fillStyle=g; ctx.globalAlpha=.42; ctx.beginPath(); ctx.moveTo(bx,by-h*.92); ctx.arc(bx,by-h*.92,W,ang-spread,ang+spread); ctx.closePath(); ctx.fill(); ctx.globalAlpha=1;
  function wave(yBase, a, f1, f2, sp, col, al, foamGap){
    ctx.beginPath(); ctx.moveTo(0,H);
    for(let x=0;x<=W;x+=16*DPR){
      const y = yBase + Math.sin(x*f1 + t*sp)*a + Math.sin(x*f2 + t*(sp*.62))*a*.55;
      ctx.lineTo(x,y);
    } ctx.lineTo(W,H); ctx.closePath(); ctx.fillStyle=col; ctx.globalAlpha=al; ctx.fill(); ctx.globalAlpha=1;
    ctx.globalAlpha=.28; ctx.fillStyle='#fff';
    for(let x=0;x<=W;x+=foamGap*DPR){ const y = yBase + Math.sin(x*f1 + t*sp)*a; ctx.fillRect(x,y-2.5*DPR,7*DPR,2*DPR); }
    ctx.globalAlpha=1;
  }
  wave(H*0.60,16*DPR,0.006,0.0032,0.0030,c[2],.36,26);
  wave(H*0.68,20*DPR,0.007,0.0036,0.0025,c[3],.28,30);
  wave(H*0.76,24*DPR,0.008,0.0040,0.0022,c[4],.22,34);
}

/* ===== SUNSET ===== */
function ensureGulls(){ if(gulls) return; gulls=Array.from({length:2},()=>({x:Math.random()*W*.6+W*.2,y:H*(.28+.08*Math.random()),dir:Math.random()<.5?-1:1})); }
function ensureBoat(){ if(boat) return; const horizon=H*.62; boat={x:W*.15,y:horizon+8*DPR,dir:1,spd:0.008*DPR}; }
function drawBoat(b){
  ctx.save(); ctx.translate(b.x,b.y);
  ctx.fillStyle='#263545';
  ctx.beginPath(); ctx.moveTo(-22*DPR,0); ctx.lineTo(22*DPR,0); ctx.lineTo(14*DPR,6*DPR); ctx.lineTo(-14*DPR,6*DPR); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#f7efe2aa'; ctx.beginPath(); ctx.moveTo(0,-2*DPR); ctx.lineTo(0,-22*DPR); ctx.lineTo(12*DPR,-2*DPR); ctx.closePath(); ctx.fill();
  ctx.restore();
}
function drawSunset(dt){
  const c=PALETTES.sunset; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,c[0]); g.addColorStop(1,c[2]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  const horizon=H*.62; const sx=W*.5, sy=Math.min(horizon-10*DPR, H*.42 + Math.sin(t*0.00012)*6*DPR), sr=110*DPR;
  const glow=ctx.createRadialGradient(sx,sy,0,sx,sy,sr*1.8); glow.addColorStop(0,'#fff2'); glow.addColorStop(1,'#0000'); ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(sx,sy,sr*1.8,0,TAU); ctx.fill();
  ctx.fillStyle='#fff1cc'; ctx.beginPath(); ctx.arc(sx,sy,sr,0,TAU); ctx.fill();
  let sea=ctx.createLinearGradient(0,horizon,0,H); sea.addColorStop(0,c[2]); sea.addColorStop(1,c[3]); ctx.fillStyle=sea; ctx.fillRect(0,0,W,H-horizon);
  ctx.globalAlpha=.45; ctx.fillStyle='#fff'; for(let x=0;x<=W;x+=18*DPR){ const y=horizon + Math.sin(x*0.01 + t*0.002)*3*DPR; ctx.fillRect(x,y,8*DPR,1.5*DPR); } ctx.globalAlpha=1;
  ctx.globalAlpha=.35; for(let i=0;i<60;i++){ const rx=sx + (Math.random()*2-1)*i*6*DPR; const ry=sy + i*5*DPR; ctx.fillRect(rx,ry,6*DPR,2*DPR); } ctx.globalAlpha=1;
  ensureGulls(); ctx.fillStyle='#2b3a4d'; ctx.globalAlpha=.6; gulls.forEach(gb=>{ gb.x+=gb.dir*0.06*DPR*dt; if(gb.x<-20) gb.x=W+20; if(gb.x>W+20) gb.x=-20;
    ctx.beginPath(); ctx.moveTo(gb.x,gb.y); ctx.lineTo(gb.x-12*DPR*gb.dir,gb.y+4*DPR); ctx.lineTo(gb.x-24*DPR*gb.dir,gb.y); ctx.closePath(); ctx.fill(); });
  ctx.globalAlpha=1;
  ensureBoat(); drawBoat(boat); boat.x += boat.spd*dt; if(boat.x>W+40) boat.x=-40;
}

/* ===== RAIN ===== */
function ensureRain(){ if(rainDrops) return; const base=(QUALITY.detail==='rich'?200:QUALITY.detail==='lite'?120:170)*DPR*QUALITY.scale*DENSITY*DETAIL_MULT;
  rainDrops=Array.from({length:Math.floor(base)},()=>{ const s=1+Math.random()*1.6; return {x:Math.random()*W,y:Math.random()*H,vx:-2*s*DPR,vy:9*s*DPR,l:(10+Math.random()*12)*DPR,a:.25+.35*Math.random(),rip:Math.random()<.25}; });
}
function drawRain(dt){
  const c=PALETTES.rain; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,c[0]); g.addColorStop(1,c[2]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ensureRain(); ctx.strokeStyle=c[4]; ctx.lineWidth=1*DPR;
  for(const d of rainDrops){
    ctx.globalAlpha=d.a; ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x+d.vx*1.6,d.y+d.l); ctx.stroke();
    if(d.y>H*.85 && d.rip){ ctx.globalAlpha=.18; ctx.beginPath(); const r=6*DPR + (d.y%5); ctx.ellipse(d.x, H*.85, r*1.7, r, 0, 0, TAU); ctx.stroke(); }
    d.x+=d.vx; d.y+=d.vy; if(d.y>H+20){d.y=-10; d.x=Math.random()*W;} if(d.x<-10)d.x=W+10;
  } ctx.globalAlpha=1;
}

/* ===== FOG ===== */
function ensureFog(){ if(fogLayers) return; const n=8; fogLayers=Array.from({length:n},(_,i)=>({y:H*.4+i*H*.07,a:.05+.06*i,off:Math.random()*1000})); }
function drawFog(dt){
  const p=PALETTES.fog; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,p[0]); g.addColorStop(1,p[1]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ensureFog();
  ctx.fillStyle=p[2]; ctx.globalAlpha=.18; ctx.beginPath(); ctx.moveTo(0,H);
  for(let x=0;x<=W;x+=28*DPR){ ctx.lineTo(x, H*.78 + Math.sin(x*0.002 + t*0.0002)*12*DPR); }
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill(); ctx.globalAlpha=1;
  for(const f of fogLayers){ ctx.globalAlpha=f.a; ctx.beginPath(); ctx.moveTo(0,H);
    for(let x=0;x<=W;x+=34*DPR){ const y=f.y + Math.sin((x*0.002 + (t*0.00018+f.off)))*18*DPR; ctx.lineTo(x,y); }
    ctx.lineTo(W,H); ctx.closePath(); ctx.fillStyle='#fff'; ctx.fill(); }
  ctx.globalAlpha=1;
}

/* ===== AURORA ===== */
function ensureSnow(){ if(snowFlakes) return; const n=Math.floor((QUALITY.detail==='rich'?140:QUALITY.detail==='lite'?80:115)*QUALITY.scale*DENSITY*DETAIL_MULT); snowFlakes = Array.from({length:n},()=>({x:Math.random()*W,y:Math.random()*H,r:(.8+Math.random()*1.4)*DPR,vx:(-0.3+Math.random()*0.6)*DPR,vy:(0.35+Math.random()*0.9)*DPR,tw:Math.random()*TAU})); }
function drawSnow(){ if(!snowFlakes) return; ctx.fillStyle='#fff';
  for(const f of snowFlakes){ const sway = Math.sin(f.tw + t*0.0012)*0.6*DPR; ctx.globalAlpha=.7; ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, TAU); ctx.fill(); f.x += f.vx + sway*0.02; f.y += f.vy; if(f.y>H+6){ f.y=-6; f.x=Math.random()*W; } if(f.x<-6){ f.x=W+6; } if(f.x>W+6){ f.x=-6; } }
  ctx.globalAlpha=1;
}
function drawAurora(dt){
  const c=PALETTES.aurora; ctx.clearRect(0,0,W,H);
  let bg=ctx.createLinearGradient(0,0,0,H); bg.addColorStop(0,c[0]); bg.addColorStop(1,c[1]); ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  for(let i=0;i<4;i++){
    const phase=t*0.00025+i*1.2; const band=ctx.createLinearGradient(0,0,W,0);
    band.addColorStop(0,c[3]+'00'); band.addColorStop(.35,c[3]+'66'); band.addColorStop(.5,c[4]+'88'); band.addColorStop(.7,c[3]+'66'); band.addColorStop(1,c[3]+'00');
    ctx.fillStyle=band; ctx.globalAlpha=.50; const y=H*.3+Math.sin(phase)*H*.12+i*H*.08;
    ctx.beginPath(); ctx.moveTo(0,y); for(let x=0;x<=W;x+=20*DPR){ const dy=Math.sin(phase+x*0.0024 + Math.sin(x*0.0011+i))*26*DPR; ctx.lineTo(x,y+dy); }
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill();
  } for(let i=0;i<6;i++){ const rx=(90+i*40)*DPR*(1+.05*Math.sin(t*0.0006+i)); const x0=W*(.2+.6*Math.random()); const y0=H*(.18+.4*Math.random()); const grd=ctx.createRadialGradient(x0,y0,0,x0,y0,rx); grd.addColorStop(0,c[4]+'22'); grd.addColorStop(1,c[4]+'00'); ctx.globalAlpha=.18; ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(x0,y0,rx,0,TAU); ctx.fill(); } ctx.globalAlpha=1; ensureSnow(); drawSnow();
}

/* ===== DESERT ===== */
function ensureDunes(){ if(duneLayers) return; const rand=rng((W|0)+(H|0)+999); duneLayers=[];
  for(let i=0;i<4;i++){
    const y=H*(.58 + i*.08), amp=(26+i*12)*DPR, seg=12+i*2, step=W/seg;
    const pts=[[0,H]];
    for(let s=0;s<=seg;s++){ const x=s*step; const crest = y + Math.sin(s*0.9)*amp*0.18 + (rand()*2-1)*amp*0.6; pts.push([x,crest]); }
    pts.push([W,H]); duneLayers.push({pts, col:PALETTES.desert[2+(i%3)], alpha:.18+.06*i});
  }
}
function ensureDesertProps(){ if(desertProps) return; const rand=rng(424242); desertProps={cacti:[],rocks:[]};
  const nC=Math.floor(10*DENSITY*DETAIL_MULT), nR=Math.floor(10*DENSITY*DETAIL_MULT);
  for(let i=0;i<nC;i++){ desertProps.cacti.push({x:Math.random()*W*.9+W*.05, y:H*.70+Math.random()*H*.18, h:(40+rand()*80)*DPR, arms:rand()<.7}); }
  for(let i=0;i<nR;i++){
    const w = Math.max(6*DPR, Math.abs(12 + rand()*28) * DPR);
    desertProps.rocks.push({x:Math.random()*W, y:H*.78+Math.random()*H*.14, w});
  }
}
function drawDunes(){ duneLayers.forEach(l=>{ ctx.fillStyle=l.col; ctx.globalAlpha=l.alpha; ctx.beginPath(); l.pts.forEach(([x,y],k)=> (k?ctx.lineTo(x,y):ctx.moveTo(x,y))); ctx.closePath(); ctx.fill(); }); ctx.globalAlpha=1; }
function drawCactus(x,y,h){
  ctx.fillStyle='#367b5a'; pathRoundedRect(ctx, x-6*DPR, y-h, 12*DPR, h, 6*DPR); ctx.fill();
  ctx.fillStyle='#2f6b4f'; for(let i=0;i<8;i++){ ctx.globalAlpha=.25; ctx.fillRect(x-1*DPR, y-h + i*h/8, 2*DPR, h/10); } ctx.globalAlpha=1;
  ctx.fillStyle='#367b5a'; pathRoundedRect(ctx, x-18*DPR, y-h*.6, 12*DPR, h*.35, 6*DPR); ctx.fill();
  pathRoundedRect(ctx, x+6*DPR, y-h*.45, 12*DPR, h*.28, 6*DPR); ctx.fill();
}
function drawRock(x,y,w){
  const rx = RAD(w);
  const ry = RAD(w * 0.6);
  ctx.save();
  ctx.fillStyle='#8b7a6a';
  ctx.beginPath();
  ctx.ellipse(x,y,rx,ry,0,0,TAU);
  ctx.fill();
  ctx.globalAlpha=.18;
  ctx.fillStyle='#000';
  ctx.beginPath();
  ctx.ellipse(x + rx*0.1, y + ry*0.08, rx*0.6, ry*0.35, 0, 0, TAU);
  ctx.fill();
  ctx.restore();
}
/* raffiche leggere e non continue */
function updateDesertGust(dt){
  if(!desertGust) desertGust={active:false,until:0,next:3000};
  if(!desertGust.active && t>desertGust.next){
    desertGust.active=true;
    desertGust.until = t + (1200 + Math.random()*1800);
    desertGust.strength = 0.06 + Math.random()*0.08;
    const count=Math.floor(90*DENSITY*DETAIL_MULT);
    sandBurst = Array.from({length:count},()=>({
      x: Math.random()*W, y: H*(.65+.25*Math.random()),
      vx: (1.3+Math.random()*2.2)*DPR, vy: (-0.15+Math.random()*0.25)*DPR,
      life: 500 + Math.random()*700, a: .18+.25*Math.random(), w:(1+Math.random()*2)*DPR, h:(1+Math.random()*1.5)*DPR
    }));
  }
  if(desertGust.active && t>desertGust.until){
    desertGust.active=false; desertGust.next = t + (5000 + Math.random()*9000); sandBurst=null;
  }
}
function drawDesert(dt){
  const c=PALETTES.desert; ctx.clearRect(0,0,W,H);
  let g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,c[0]); g.addColorStop(1,c[1]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ensureDunes(); drawDunes(); ensureDesertProps();
  /* oggetti statici */
  desertProps.cacti.forEach(k=> drawCactus(k.x,k.y,k.h));
  desertProps.rocks.forEach(r=> drawRock(r.x,r.y,r.w));

  /* raffiche leggere */
  updateDesertGust(dt);
  if(desertGust.active){
    // bagliore sabbia in cresta
    ctx.globalAlpha=.12;
    ctx.fillStyle='#e8d2aa';
    ctx.beginPath(); ctx.moveTo(0,H);
    for(let x=0;x<=W;x+=24*DPR){ const y=H*.74 + Math.sin(x*0.002 + t*0.0001)*8*DPR; ctx.lineTo(x,y); }
    ctx.lineTo(W,H); ctx.closePath(); ctx.fill();
    ctx.globalAlpha=1;
    // particelle di sabbia (leggermente più visibili)
    if(sandBurst){
      ctx.fillStyle='#e6d2b5';
      sandBurst.forEach(p=>{
        ctx.globalAlpha=p.a;
        ctx.fillRect(p.x,p.y,p.w,p.h);
        p.x += p.vx; p.y += p.vy; p.life -= dt;
        if(p.x>W) p.x= -4*DPR;
      });
      ctx.globalAlpha=1;
    }
  }
}

/* ===== DRAW map & render ===== */

// ===== Background Video Control =====
const bgVideo = document.getElementById('bgVideo');
let videoTheme = null;
function showVideoForTheme(key){
  const conf = THEME_VIDEOS[key];
  if(!bgVideo || !conf) { hideVideo(); return false; }
  // set poster (optional) and source
  if (conf.poster) bgVideo.setAttribute('poster', conf.poster);
  // Prefer webm, fallback mp4; assign via <source> for better type hinting
  bgVideo.innerHTML = '';
  const addSrc = (src, type) => { if(src){ const s=document.createElement('source'); s.src=src; s.type=type; bgVideo.appendChild(s);} };
  addSrc(conf.webm, 'video/webm');
  addSrc(conf.mp4,  'video/mp4');
  try {
    bgVideo.load();
    const playPromise = bgVideo.play();
    if (playPromise) playPromise.catch(()=>{});
    bgVideo.classList.add('is-visible');
    // hide canvas fallback
    const c = document.getElementById('bgCanvas'); if (c) c.style.display = 'none';
    videoTheme = key;
    return true;
  } catch(e){ hideVideo(); return false; }
}
function hideVideo(){
  if(!bgVideo) return;
  bgVideo.pause();
  bgVideo.classList.remove('is-visible');
  // show canvas fallback
  const c = document.getElementById('bgCanvas'); if (c) c.style.display = '';
  videoTheme = null;
}
// Improve autoplay reliability on iOS
if (bgVideo){ bgVideo.muted = true; bgVideo.playsInline = true; bgVideo.setAttribute('playsinline',''); }

function setBackgroundTheme(key){
  if(key===currentTheme) return;
  prevTheme=currentTheme; currentTheme=key; transition=1.0;
  applyThemeUI(key);

  if(key!=='forest'){ forestLayers=null; fireflies=null; }
  if(key!=='mountains'){ mountainRidges=null; birds=null; clouds=null; snowCaps=null; }
  if(key!=='aurora'){ snowFlakes=null; }
  if(key!=='desert'){ duneLayers=null; desertProps=null; desertGust={active:false,until:0,next:t+4000}; sandBurst=null; }
  if(key!=='rain'){ rainDrops=null; }
  if(key!=='sunset'){ gulls=null; boat=null; }
}
const DRAW = { showcase:drawShowcase, night:drawNight, mountains:drawMountains, desert:drawDesert, sunset:drawSunset, forest:drawForest, ocean:drawOcean, rain:drawRain, fog:drawFog, aurora:drawAurora };
function render(now){
  try{
    if(!last) last=now; const dt=now-last; last=now; t+=dt; autoQualityTick(dt);
    (DRAW[currentTheme]||drawShowcase)(dt);
    if(transition>0){ ctx.save(); ctx.globalAlpha=Math.max(0,Math.min(1,transition)); (DRAW[prevTheme]||drawShowcase)(0); ctx.restore(); transition-=transitionSpeed; }
    applyFX();
  }catch(err){
    console.error('Render error, fallback to showcase:', err);
    currentTheme='night'; transition=0;
  }
  requestAnimationFrame(render);
}
requestAnimationFrame(render);

/* ===== Thumbnails (generate) ===== */
function generateThumb(kind,w=960,h=540){
  const c=document.createElement('canvas'); c.width=w; c.height=h; const x=c.getContext('2d'); const p=PALETTES[kind];
  const g=x.createLinearGradient(0,0,0,h); g.addColorStop(0,p[0]); g.addColorStop(1,p[1]); x.fillStyle=g; x.fillRect(0,0,w,h);

  if(kind==='forest'){ const off = buildForestLayer(Math.floor(w*1.2), h, 1337, p[3], 1.2); x.drawImage(off, -w*0.1, h*0.05, off.width, off.height); x.fillStyle='#fff'; x.globalAlpha=.6; for(let i=0;i<40;i++){ x.beginPath(); x.arc(Math.random()*w, h*.6+Math.random()*h*.35, 2,0,TAU); x.fill(); } }
  else if(kind==='mountains'){ const pts = buildRidgePoints(h*.6, 30, 12, .6, 2468); x.fillStyle=p[2]; x.globalAlpha=.5; x.beginPath(); x.moveTo(0,h); pts.forEach(pt=>x.lineTo(pt[0]/960*w, pt[1])); x.lineTo(w,h); x.closePath(); x.fill(); x.globalAlpha=1; x.fillStyle='#fff'; for(let i=0;i<8;i++){ x.globalAlpha=.4; x.beginPath(); x.moveTo(i*w/8, h*.45); x.lineTo(i*w/8+12, h*.48); x.lineTo(i*w/8-12, h*.48); x.closePath(); x.fill(); } }
  else if(kind==='ocean'){
    const bx=w*0.78, by=h*0.68;
    x.fillStyle='#26425f'; x.globalAlpha=.95;
    x.beginPath(); x.moveTo(bx-140,by+40); x.quadraticCurveTo(bx-60,by-30,bx+20,by+8); x.lineTo(bx+140,by+60); x.lineTo(bx-140,by+60); x.closePath(); x.fill();
    x.fillStyle='#17324d'; const th=130;
    x.fillRect(bx-10,by-th,20,th); x.fillRect(bx-16,by-th*0.85,32,6); x.fillRect(bx-12,by-th*0.15,24,6);
    x.globalAlpha=.45; x.fillStyle='#fff';
    for(let i=0;i<5;i++){ const y=by+30+i*12; for(let j=0;j<w;j+=24){ const yy=y+Math.sin(j*0.02+i)*3; x.fillRect(j,yy,10,2); } }
    x.globalAlpha=1;
  }
  else if(kind==='sunset'){ x.fillStyle='#fff2cc'; x.beginPath(); x.arc(w*.52,h*.42,80,0,TAU); x.fill(); x.globalAlpha=.6; x.fillStyle='#fff'; for(let i=0;i<30;i++){ x.fillRect(w*.52+(Math.random()*2-1)*i*4, h*.42+i*4, 6,2); } x.globalAlpha=1; }
  else if(kind==='night'){ x.fillStyle='#fff'; for(let i=0;i<80;i++){ x.globalAlpha=.5+Math.random()*.5; x.fillRect(Math.random()*w,Math.random()*h*.9,3,3); } }
  else if(kind==='aurora'){ const band=x.createLinearGradient(0,0,w,0); band.addColorStop(0,p[3]+'00'); band.addColorStop(.35,p[3]+'66'); band.addColorStop(.5,p[4]+'88'); band.addColorStop(.7,p[3]+'66'); band.addColorStop(1,p[3]+'00'); x.fillStyle=band; x.globalAlpha=.6; x.fillRect(0,h*.35,w,h*.3); }
  else if(kind==='desert'){ x.fillStyle=p[3]; x.globalAlpha=.35; x.fillRect(w*.22,h*.72,8,60); x.fillRect(w*.28,h*.76,8,48); x.globalAlpha=1; }
  else if(kind==='rain'){ x.fillStyle='#fff'; x.globalAlpha=.95; x.beginPath(); x.arc(w*.4,h*.36,46,0,TAU); x.arc(w*.46,h*.34,60,0,TAU); x.arc(w*.53,h*.36,50,0,TAU); x.fill(); x.globalAlpha=.8; x.strokeStyle='#fff'; x.lineWidth=3; for(let i=0;i<30;i++){ const rx=Math.random()*w*.8+w*.1, ry=h*.45+Math.random()*h*.35; x.beginPath(); x.moveTo(rx,ry); x.lineTo(rx-20,ry+36); x.stroke(); } x.globalAlpha=1; }
  return c.toDataURL('image/png',0.9);
}

/* ===== Cards + Pager ===== */
const slidesEl=S('slides'), swipe=S('swipe'), pager=S('pager');
THEMES.forEach(t=>{
  const slide=document.createElement('div'); slide.className='slide'; slide.dataset.theme=t.key;
  slide.innerHTML = `<div class="themeTitle" aria-hidden="false">${t.label}</div>`;
  slidesEl.appendChild(slide);
  slide.addEventListener('click',()=>{ const i=Array.from(slidesEl.children).indexOf(slide); snapTo(i,true); });
});
let idx=0, slideCount=THEMES.length, startX=0, curX=0, dragging=false, pointerId=null, slideW=0, focusedIdx=0;
function buildPager(){ pager.innerHTML=''; for(let i=0;i<slideCount;i++){ const b=document.createElement('button'); if(i===0) b.classList.add('active'); b.addEventListener('click',()=>snapTo(i,true)); pager.appendChild(b);} }
buildPager();
function updatePager(raw){
  const dots=[...pager.children];
  dots.forEach((d,k)=>{
    const dist=Math.abs(k-raw);
    const w=10 + 22*Math.max(0, 1 - Math.min(1,dist));
    const op=0.35 + 0.6*Math.max(0, 1 - Math.min(1,dist));
    d.style.width=w+'px';
    d.style.opacity=op.toFixed(2);
    d.classList.toggle('active', Math.round(raw)===k);
  });
}
function applyTransform(x){ slidesEl.style.transform=`translate3d(${x}px,0,0)`; slidesEl.style.transition='none'; }
function measure(){ slideW = swipe.getBoundingClientRect().width; }
function forceSnap(){ measure(); slidesEl.style.transition='transform .35s cubic-bezier(.2,.9,.2,1)'; slidesEl.style.transform=`translate3d(${-idx*slideW}px,0,0)`; setBackgroundTheme(THEMES[idx].key); highlight(); updatePager(idx); }
function highlight(){ [...slidesEl.children].forEach((el,k)=> el.classList.toggle('selected', k===idx)); }
function snapTo(index,userAction=false){
  idx=Math.max(0,Math.min(slideCount-1,index)); focusedIdx=idx; forceSnap();
  if(isThemeScreen){ previewAudioForIndex(idx); }
  if(userAction){ if(navigator.vibrate) navigator.vibrate(6); }
}
measure(); snapTo(0,false);
slidesEl.addEventListener('pointerdown',e=>{ dragging=true; pointerId=e.pointerId; slidesEl.setPointerCapture(pointerId); slidesEl.classList.add('dragging'); slidesEl.style.transition='none'; measure(); startX=e.clientX; curX=-idx*slideW;});
slidesEl.addEventListener('pointermove',e=>{ if(!dragging || e.pointerId!==pointerId) return; const dx=e.clientX-startX; const x=curX+dx; applyTransform(x); const raw=-x/slideW; const clamped=Math.max(0,Math.min(slideCount-1,raw)); const rounded=Math.round(raw); if(rounded!==focusedIdx){ focusedIdx=rounded; setBackgroundTheme(THEMES[focusedIdx].key); if(isThemeScreen){ previewAudioForIndex(focusedIdx); } } updatePager(clamped); });
function endDrag(e){ if(!dragging || (e && e.pointerId!==pointerId)) return; dragging=false; slidesEl.classList.remove('dragging'); snapTo(focusedIdx,false); try{slidesEl.releasePointerCapture(pointerId);}catch(_){ } pointerId=null; }
slidesEl.addEventListener('pointerup',endDrag); slidesEl.addEventListener('pointercancel',endDrag); slidesEl.addEventListener('pointerleave',()=> dragging && endDrag(null));
slidesEl.addEventListener('wheel',e=>{ const d=Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:e.deltaY; if(Math.abs(d)<12) return; e.preventDefault(); snapTo(d>0?idx+1:idx-1,true); },{passive:false});
addEventListener('keydown',e=>{ if(!S('theme').classList.contains('active')) return; if(e.key==='ArrowRight') snapTo(idx+1,true); if(e.key==='ArrowLeft') snapTo(idx-1,true); if(e.key==='Escape') show('splash'); });

/* ===== Audio Core ===== */
let audioCtx=null, masterGain=null, reverbGain=null, delayNode=null, delayFeedback=null, comp=null;
let isMuted=false, activeNodes=[], activeTimers=[], ambienceNodes=[];
let intensity=0.62, initialVolume=.34, reverbAmt=.38;
let motif='bowl';

function ensureAudio(){
  try{
    if(!audioCtx){
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      masterGain=audioCtx.createGain(); masterGain.gain.value=isMuted?0:initialVolume;
      comp=audioCtx.createDynamicsCompressor(); comp.threshold.value=-28; comp.knee.value=24; comp.ratio.value=2.5; comp.attack.value=0.01; comp.release.value=0.25;
      delayNode=audioCtx.createDelay(1.2); delayNode.delayTime.value=.32;
      delayFeedback=audioCtx.createGain(); delayFeedback.gain.value=.16; delayNode.connect(delayFeedback); delayFeedback.connect(delayNode);
      const convolver=audioCtx.createConvolver(); convolver.buffer=createImpulse(audioCtx,2.4,2.8);
      reverbGain=audioCtx.createGain(); reverbGain.gain.value=reverbAmt; reverbGain.connect(convolver); convolver.connect(masterGain);
      masterGain.connect(delayNode); delayNode.connect(comp); comp.connect(audioCtx.destination);
    } return true;
  }catch(e){ console.warn('WebAudio non disponibile',e); return false; }
}
function createImpulse(ctx,seconds=1.8,decay=2.4){ const rate=ctx.sampleRate,len=rate*seconds,b=ctx.createBuffer(2,len,rate);
  for(let c=0;c<2;c++){ const ch=b.getChannelData(c); for(let i=0;i<len;i++){ ch[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay); } } return b; }
function stopAll(){ activeNodes.forEach(n=>{try{n.stop?.(0);n.disconnect?.()}catch(e){}}); activeNodes=[]; activeTimers.forEach(clearTimeout); activeTimers=[]; ambienceNodes.forEach(n=>{try{n.stop?.(0);n.disconnect?.()}catch(e){}}); ambienceNodes=[]; }
function addAutoPan(source, { freq = .05, depth = 1 } = {}) {
  const pan = audioCtx.createStereoPanner();
  const lfo = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  lfo.type = 'sine'; lfo.frequency.value = freq; g.gain.value = depth; lfo.connect(g); g.connect(pan.pan); lfo.start();
  source.connect(pan); activeNodes.push(pan,lfo,g); return pan;
}
function envGain(val,when=0){ const g=audioCtx.createGain(); g.gain.value=0.0001; const t=audioCtx.currentTime+when; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(val,t+.04); return g; }
function pentatonic(base=220){ return [0,2,4,7,9,12,14,16,19,21].map(x=> base*Math.pow(2,x/12)); }

/* motifs */
function playBowl(freq=196, dur=4, gain=.085){
  const o=audioCtx.createOscillator(); const sh=audioCtx.createOscillator(); const g=audioCtx.createGain(); const g2=audioCtx.createGain();
  o.type='sine'; sh.type='triangle'; o.frequency.value=freq; sh.frequency.value=freq*2; g.gain.value=0.0001; g2.gain.value=0.0001;
  o.connect(g); sh.connect(g2);
  const mix=audioCtx.createGain(); g.connect(mix); g2.connect(mix);
  const pan=addAutoPan(mix,{freq:.02,depth:.6}); pan.connect(masterGain); pan.connect(reverbGain);
  const now=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(gain,now+.08); g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
  g2.gain.exponentialRampToValueAtTime(gain*.35,now+.05); g2.gain.exponentialRampToValueAtTime(0.0001,now+dur*.7);
  o.start(); sh.start(); o.stop(now+dur+.1); sh.stop(now+dur*.75+.1); activeNodes.push(o,sh,g,g2,mix,pan);
}
function playChime(freq=880, dur=.9, gain=.052){
  const o=audioCtx.createOscillator(); o.type='triangle'; o.frequency.value=freq;
  const g=envGain(gain); const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=freq; bp.Q.value=10;
  o.connect(bp); bp.connect(g);
  const p=addAutoPan(g,{freq:.12,depth:.9}); p.connect(masterGain); p.connect(reverbGain); p.connect(delayNode);
  const t0=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.0001,t0+dur); o.start(t0); o.stop(t0+dur+.05); activeNodes.push(o,g,bp,p);
}
function playKalimba(freq=440, dur=.6, gain=.06){
  const o=audioCtx.createOscillator(); o.type='square'; o.frequency.value=freq;
  const g=envGain(gain); const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1600; lp.Q.value=.7;
  o.connect(lp); lp.connect(g);
  const p=addAutoPan(g,{freq:.07,depth:.8}); p.connect(masterGain); p.connect(reverbGain);
  const t0=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.0001,t0+dur); o.start(t0); o.stop(t0+dur+.05); activeNodes.push(o,g,lp,p);
}
function motifBurst(scale){
  const pick=()=> scale[Math.floor(Math.random()*scale.length)]*(1+(Math.random()*0.003-0.0015));
  if(motif==='bowl'){ playBowl(pick(),3.5,.085); }
  else if(motif==='chimes'){ playChime(pick()*2,.95,.052); }
  else { playKalimba(pick(),.62,.06); }
}
function motifTick(scale){
  function tick(){
    const speedMult=1-intensity*0.55;
    const n=(motif==='chimes'?2:1)+Math.floor(Math.random()*2);
    for(let i=0;i<n;i++){
      const f=scale[Math.floor(Math.random()*scale.length)];
      const det=1+(Math.random()*0.004-0.002);
      if(motif==='bowl') playBowl(f*det, 3.5, .08);
      else if(motif==='chimes') playChime(f*det*2, .9, .05);
      else playKalimba(f*det, .6, .058);
    }
    const ms=(4500+Math.random()*3500)*speedMult; const id=setTimeout(tick,ms); activeTimers.push(id);
  } tick();
}

/* Ambienti per tema */
function noiseBuffer(seconds=2){ const rate=audioCtx.sampleRate, len=rate*seconds, buf=audioCtx.createBuffer(1,len,rate); const data=buf.getChannelData(0); for(let i=0;i<len;i++){ data[i]=Math.random()*2-1; } return buf; }
function startAmbience(kind){
  if(!audioCtx) return;
  function makeChain(buf){
    const src=audioCtx.createBufferSource(); src.buffer=buf; src.loop=true;
    const g=audioCtx.createGain(); g.gain.value=.028 + .07*intensity;
    const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1400; lp.Q.value=.4;
    const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=350; bp.Q.value=.8;
    src.connect(lp); lp.connect(bp); bp.connect(g);
    const pan=addAutoPan(g,{freq:.015,depth:.6}); pan.connect(masterGain); pan.connect(reverbGain);
    src.start(); ambienceNodes.push(src,g,lp,bp,pan); return {src,g,lp,bp,pan};
  }
  function lfoParam(param,freq,depth,offset){ const lfo=audioCtx.createOscillator(); const amp=audioCtx.createGain(); lfo.type='sine'; lfo.frequency.value=freq; amp.gain.value=depth; lfo.connect(amp); amp.connect(param); if(offset!==undefined) param.setValueAtTime(offset,audioCtx.currentTime); lfo.start(); ambienceNodes.push(lfo,amp); }

  const buf=noiseBuffer(2.5); const ch=makeChain(buf);

  const seagulls=()=>{ function call(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=700; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.1,depth:.7}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; o.frequency.exponentialRampToValueAtTime(1100,t0+.35); g.gain.exponentialRampToValueAtTime(.03,t0+.05); g.gain.exponentialRampToValueAtTime(0.0001,t0+.6); o.start(t0); o.stop(t0+.7); activeNodes.push(o,g,p); } call(); function tick(){ if(Math.random()<.28) call(); const id=setTimeout(tick,1300+Math.random()*1800); activeTimers.push(id);} tick(); };
  const softSurf=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=140; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.02,depth:.5}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(.024,t0+.9); g.gain.linearRampToValueAtTime(0.0001,t0+2.6); o.start(t0); o.stop(t0+2.7); activeNodes.push(o,g,p); } one(); function tick(){ one(); const id=setTimeout(tick,2200+Math.random()*1200); activeTimers.push(id);} tick(); };
  const sandTinkle=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=900+Math.random()*300; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.2,depth:.6}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(.010,t0+.03); g.gain.exponentialRampToValueAtTime(0.0001,t0+.27); o.start(t0); o.stop(t0+.3); activeNodes.push(o,g,p);} one(); function tick(){ one(); const id=setTimeout(tick,600+Math.random()*800); activeTimers.push(id);} tick(); };
  const distantThunder=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=60; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.01,depth:.3}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(.035,t0+1.0); g.gain.linearRampToValueAtTime(0.0001,t0+3.2); o.start(t0); o.stop(t0+3.3); activeNodes.push(o,g,p);} one(); function tick(){ one(); const id=setTimeout(tick,7000+Math.random()*8000); activeTimers.push(id);} tick(); };
  const fogHorn=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=90; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.005,depth:.4}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(.035,t0+.4); g.gain.linearRampToValueAtTime(0.0001,t0+2.6); o.start(t0); o.stop(t0+2.7); activeNodes.push(o,g,p);} one(); function tick(){ if(Math.random()<.20) one(); const id=setTimeout(tick,4800+Math.random()*6800); activeTimers.push(id);} tick(); };
  const leavesRustle=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(), sh=audioCtx.createBiquadFilter();
      o.type='sawtooth'; o.frequency.value=40; g.gain.value=0.0001; sh.type='highpass'; sh.frequency.value=900; sh.Q.value=0.7;
      o.connect(g); g.connect(sh); const p=addAutoPan(sh,{freq:.07,depth:.8}); p.connect(masterGain); p.connect(reverbGain);
      const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(.02,t0+.2); g.gain.linearRampToValueAtTime(0.0001,t0+.9);
      o.start(t0); o.stop(t0+1.0); activeNodes.push(o,g,sh,p);} one(); function tick(){ one(); const id=setTimeout(tick,1600+Math.random()*1600); activeTimers.push(id);} tick(); };
  const brooklet=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=280+Math.random()*30; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.15,depth:.6}); p.connect(masterGain); const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(.012,t0+.05); g.gain.exponentialRampToValueAtTime(0.0001,t0+.18); o.start(t0); o.stop(t0+.22); activeNodes.push(o,g,p);} one(); function tick(){ one(); const id=setTimeout(tick,220+Math.random()*120); activeTimers.push(id);} tick(); };
  const windGusts=(mult=.2)=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=100; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.02,depth:.8}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; g.gain.linearRampToValueAtTime(0.03*mult*(.8+.4*Math.random()),t0+.8); g.gain.linearRampToValueAtTime(0.0001,t0+2.8); o.start(t0); o.stop(t0+3.0); activeNodes.push(o,g,p);} one(); function tick(){ one(); const id=setTimeout(tick,3800+Math.random()*4800); activeTimers.push(id);} tick(); };
  const crickets=()=>{ function one(){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=880; g.gain.value=0.0001; o.connect(g); const p=addAutoPan(g,{freq:.4,depth:.7}); p.connect(masterGain); p.connect(reverbGain); const t0=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(.05,t0+.02); o.frequency.exponentialRampToValueAtTime(1200,t0+.12); g.gain.exponentialRampToValueAtTime(0.0001,t0+.18); o.start(); o.stop(t0+.2); activeNodes.push(o,g,p);} one(); function tick(){ if(Math.random()<.65) one(); const id=setTimeout(tick,800+Math.random()*900); activeTimers.push(id);} tick(); };

  if(kind==='ocean'){ ch.lp.frequency.value=1200; ch.bp.type='bandpass'; ch.bp.frequency.value=300; ch.bp.Q.value=.8; lfoParam(ch.lp.frequency,0.05,350,1000); lfoParam(ch.bp.frequency,0.04,120,300); seagulls(); softSurf(); }
  if(kind==='rain'){ ch.lp.frequency.value=4200; ch.bp.type='highpass'; ch.bp.frequency.value=2200; ch.bp.Q.value=.9; lfoParam(ch.bp.frequency,0.13,240,2100); distantThunder(); }
  if(kind==='forest'){ ch.lp.frequency.value=1100; ch.bp.type='bandpass'; ch.bp.frequency.value=650; ch.bp.Q.value=.8; lfoParam(ch.bp.frequency,0.08,160,650); leavesRustle(); brooklet(); }
  if(kind==='mountains'){ ch.lp.frequency.value=900; ch.bp.type='bandpass'; ch.bp.frequency.value=500; ch.bp.Q.value=.7; lfoParam(ch.bp.frequency,0.05,120,500); windGusts(.25); }
  if(kind==='desert'){ ch.lp.frequency.value=800; ch.bp.type='bandpass'; ch.bp.frequency.value=360; ch.bp.Q.value=.7; lfoParam(ch.bp.frequency,0.03,180,360); windGusts(.18); sandTinkle(); }
  if(kind==='night'){ ch.lp.frequency.value=900; ch.bp.type='bandpass'; ch.bp.frequency.value=450; ch.bp.Q.value=.7; lfoParam(ch.bp.frequency,0.05,120,450); crickets(); }
  if(kind==='sunset'){ ch.lp.frequency.value=1100; ch.bp.type='bandpass'; ch.bp.frequency.value=420; ch.bp.Q.value=.7; lfoParam(ch.bp.frequency,0.05,120,420); seagulls(); softSurf(); }
  if(kind==='aurora' || kind==='fog'){ ch.lp.frequency.value=700; ch.bp.type='bandpass'; ch.bp.frequency.value=250; ch.bp.Q.value=.6; lfoParam(ch.bp.frequency,0.03,140,250); fogHorn(); }
}

/* Avvio audio */
function startThemeAudio(key){
  if(!ensureAudio()) return; stopAll();
  let base,scale;
  switch(key){
    case 'night': base=196; scale=pentatonic(base); motif='bowl'; motifBurst(scale.map(f=>f*.5)); startAmbience('night'); motifTick(scale.map(f=>f*.5)); break;
    case 'mountains': base=196; scale=pentatonic(base); motif='bowl'; motifBurst(scale.map(f=>f*2)); startAmbience('mountains'); motifTick(scale.map(f=>f*2)); break;
    case 'ocean': base=196; scale=pentatonic(base); motif='chimes'; motifBurst(scale.map(f=>f*.75)); startAmbience('ocean'); motifTick(scale.map(f=>f*.75)); break;
    case 'sunset': base=220; scale=pentatonic(base); motif='bowl'; motifBurst(scale.map(f=>f*1.5)); startAmbience('sunset'); motifTick(scale.map(f=>f*1.5)); break;
    case 'desert': base=174; scale=pentatonic(base); motif='bowl'; motifBurst(scale); startAmbience('desert'); motifTick(scale); break;
    case 'forest': base=247; scale=pentatonic(base); motif='kalimba'; motifBurst(scale.map(f=>f*2)); startAmbience('forest'); motifTick(scale.map(f=>f*2)); break;
    case 'rain': base=185; scale=pentatonic(base); motif='chimes'; motifBurst(scale.map(f=>f*.75)); startAmbience('rain'); motifTick(scale.map(f=>f*.75)); break;
    case 'fog': base=155; scale=pentatonic(base); motif='bowl'; motifBurst(scale.map(f=>f*.5)); startAmbience('fog'); motifTick(scale.map(f=>f*.5)); break;
    case 'aurora': base=208; scale=pentatonic(base); motif='chimes'; motifBurst(scale.map(f=>f*2)); startAmbience('fog'); motifTick(scale.map(f=>f*2)); break;
  }
}

/* Anteprima audio durante il carosello */
const muteChk=S('muteChk'), volumeRange=S('volumeRange'), intensityRange=S('intensityRange'), reverbRange=S('reverbRange');
function previewAudioForIndex(i){
  const key=THEMES[i].key;
  if(key===lastPreviewKey) return;
  if(ensureAudio()){ if(audioCtx.state==='suspended') audioCtx.resume(); setMuted(false); }
  startThemeAudio(key);
  lastPreviewKey=key;
}

/* Audio panel bindings */
function setMuted(v){
  isMuted=v;
  if(masterGain && audioCtx){ masterGain.gain.cancelScheduledValues(audioCtx.currentTime); masterGain.gain.setTargetAtTime(isMuted?0:initialVolume,audioCtx.currentTime,.05); }
  if(muteChk){ muteChk.checked = isMuted; }
  updateMicVisual();
}
if(muteChk){ muteChk.addEventListener('change',()=> setMuted(muteChk.checked)); }
volumeRange.addEventListener('input',()=>{ initialVolume=Number(volumeRange.value)/100; if(masterGain && audioCtx){ masterGain.gain.cancelScheduledValues(audioCtx.currentTime); masterGain.gain.setTargetAtTime(isMuted?0:initialVolume,audioCtx.currentTime,.05); }});
intensityRange.addEventListener('input',()=>{ intensity=Number(intensityRange.value)/100; });
reverbRange.addEventListener('input',()=>{ reverbAmt=Number(reverbRange.value)/100; if(reverbGain) reverbGain.gain.setTargetAtTime(reverbAmt, audioCtx.currentTime, .1); });

/* ===== Toggles ===== */
const micBtn=S('micBtn'), gearBtn=S('gearBtn');
function updateMicVisual(){
  micBtn.classList.toggle('muted', isMuted);
  micBtn.setAttribute('aria-pressed', String(!isMuted));
}
micBtn.addEventListener('click',()=>{
  if(ensureAudio()){ if(audioCtx.state==='suspended') audioCtx.resume(); }
  setMuted(!isMuted);
});
gearBtn.addEventListener('click', togglePanel);

/* ===== Flow ===== */
S('startBtn').addEventListener('click',()=>{
  if(ensureAudio()){ if(audioCtx.state==='suspended') audioCtx.resume(); setMuted(false); }
  idx=0; setBackgroundTheme(THEMES[0].key); startThemeAudio(THEMES[0].key); lastPreviewKey=THEMES[0].key;
  show('theme');
});
S('confirmTheme').addEventListener('click',()=>{
  const key=THEMES[idx].key; setBackgroundTheme(key);
  if(ensureAudio()){ if(audioCtx.state==='suspended') audioCtx.resume(); }
  startThemeAudio(key); lastPreviewKey=key; show('authLanding');
});

/* ===== Auth ===== */
const nav={goLogin:()=>show('login'),goRegister:()=>show('register'),toRegister:()=>show('register'),toLogin:()=>show('login')};
Object.keys(nav).forEach(id=>{ const el=S(id); if(el) el.addEventListener('click',nav[id]); });

let users=JSON.parse(localStorage.getItem('sonqoUsers')||'{}');
if(Object.keys(users).length===0){
  users['demo@sonqo.com']={name:'Demo',password:'demo123',phrases:['Ogni respiro è un regalo','La pace inizia con un sorriso','Questo momento è tutto ciò che ho']};
  localStorage.setItem('sonqoUsers',JSON.stringify(users));
}
let currentUser=null;
S('loginBtn').addEventListener('click',()=>{ const em=S('loginEmail').value.trim(), pw=S('loginPass').value; if(!em||!pw){ S('loginMsg').textContent='Inserisci email e password'; return; } const u=users[em]; if(!u||u.password!==pw){ S('loginMsg').textContent='Credenziali non valide'; return; } currentUser={...u,email:em}; S('loginMsg').textContent=''; enterJar(); });
S('registerBtn').addEventListener('click',()=>{ const name=S('regName').value.trim(), em=S('regEmail').value.trim(), pw=S('regPass').value.trim(); if(!name||!em||!pw){ S('regMsg').textContent='Compila tutti i campi'; return; } if(users[em]){ S('regMsg').textContent='Email già registrata'; return; } users[em]={name, password:pw, phrases:[]}; localStorage.setItem('sonqoUsers',JSON.stringify(users)); S('regMsg').textContent='Account creato!'; setTimeout(()=>{ show('login'); S('loginEmail').value=em; },900); });
S('logoutBtn').addEventListener('click',()=>{ currentUser=null; show('splash'); setBackgroundTheme('showcase'); stopAll(); });

function enterJar(){ show('jar'); S('hiName').textContent=currentUser.name; updateCount(); paintStars(); S('bubble').textContent='Tocca il vaso per estrarre un pensiero'; }
function updateCount(){ S('count').textContent=currentUser?.phrases?.length||0; }

/* ===== Jar ===== */
S('jarTap').addEventListener('click',()=>{
  const jar=S('jarTap'); jar.style.animation='tap 260ms ease'; setTimeout(()=> jar.style.animation='',260);
  if(!currentUser || currentUser.phrases.length===0){ S('bubble').innerHTML='Il tuo vaso è vuoto. Aggiungi il primo pensiero.'; return; }
  const p=currentUser.phrases[Math.floor(Math.random()*currentUser.phrases.length)];
  S('bubble').textContent=`“${p}”`;
});
S('saveInline').addEventListener('click',()=>{
  const v=S('inlineInput').value.trim(); if(!v||!currentUser) return;
  currentUser.phrases.push(v); users[currentUser.email].phrases=currentUser.phrases; localStorage.setItem('sonqoUsers', JSON.stringify(users));
  S('inlineInput').value=''; updateCount(); paintStars(); S('bubble').textContent='Pensiero conservato ✨'; sparkleBurst();
});
function paintStars(){
  const jar=S('jarTap'); jar.innerHTML='';
  const n=Math.min(60,(currentUser?.phrases?.length||0)); if(n===0) return;
  for(let i=0;i<n;i++){
    const d=document.createElement('div'); d.className='star';
    const jw=parseFloat(getComputedStyle(jar).width), jh=parseFloat(getComputedStyle(jar).height);
    const x=10+Math.random()*(jw-20), y=12+Math.random()*(jh-24);
    d.style.left=x+'px'; d.style.top=y+'px';
    d.style.animationDelay=(Math.random()*1.6)+'s'; d.style.animationDuration=(1.8+Math.random()*1.2)+'s'; jar.appendChild(d);
  }
}
function sparkleBurst(){
  const jar=S('jarTap'); const jw=parseFloat(getComputedStyle(jar).width), jh=parseFloat(getComputedStyle(jar).height);
  for(let i=0;i<14;i++){
    const s=document.createElement('div'); s.className='sparkle';
    const dx=(Math.random()*(jw*0.7)-jw*0.35)+'px'; const dy=(Math.random()*-(jh*0.7))+'px';
    s.style.setProperty('--dx',dx); s.style.setProperty('--dy',dy);
    s.style.left=(jw*0.5 + (Math.random()-0.5)*jw*0.2)+'px'; s.style.top=(jh*0.5 + (Math.random()-0.5)*jh*0.1)+'px';
    jar.appendChild(s); setTimeout(()=>s.remove(),900);
  }
}

/* ===== Init ===== */
(function init(){
  detailSel.value='rich'; refreshDetail();
  onResize();
  applyThemeUI('showcase');
  setBackgroundTheme('showcase');
  updateMicVisual();
})();

/* ===== Info panel toggle ===== */
(function(){
  const infoBtn = document.getElementById('infoBtn');
  const infoPanel = document.getElementById('infoPanel');
  if(infoBtn && infoPanel){
    infoBtn.addEventListener('click', ()=> infoPanel.classList.toggle('show'));
    // close when clicking outside
    document.addEventListener('click', (e)=>{
      if(!infoPanel.contains(e.target) && e.target!==infoBtn && !infoBtn.contains(e.target)){
        infoPanel.classList.remove('show');
      }
    });
  }
})();

</script>
</body>
</html>

